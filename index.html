<!DOCTYPE html>

<head>
    <style>
        path.link {
            fill: none;
            stroke: #666;
            stroke-width: 1.5px;
        }

        circle {
            fill: #ccc;
            stroke: #fff;
            stroke: black;
            stroke-width: 1.5px;
        }

        text {
            fill: #000;
            font: 10px sans-serif;
            pointer-events: none;
        }
    </style>
    <meta charset="utf-8">
    <title>Spotify Recommender</title>
</head>

<body>

    <form onsubmit="validateForm()" id="myForm">
        <label for="artistSelect">Artist name:</label><br>
        <input id="artistSelect" name="artistSelect" type="text" required></input>
        <input type="submit"></input><br>
        <span id="error"></span>
    </form>
    <svg width="800" height="800" id="artist_graph"></svg>

    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.0/papaparse.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
    <!-- <script src="https://d3js.org/d3.v7.min.js"></script> -->
    <script type="text/javascript" src="../lib/d3.v5.min.js"></script>
    <script>

        var artist_names = [];
        var artist_uris = [];

        // Form listener for artist selection
        var form = document.getElementById("myForm");
        // Hide display items before selection
        form.style.display = "none";
        function handleForm(event) { event.preventDefault(); };
        form.addEventListener('submit', handleForm);

        // Upload possible artist names
        d3.csv("artists.csv", (d) => {
            artist_names.push(d.artist_name)
            artist_uris.push(d.artist_uri)
        }).then((d) => {
            // then give option to input once names are loaded
            form.style.display = "block";
        });

        let artist_name = "Drake";
        var chart;
        var start = 0;

        // This function is triggered once the artist selection form was submitted
        function validateForm() {
            let x = document.getElementById("artistSelect").value;
            document.getElementById("myForm");
            var error = document.getElementById("error")
            if (artist_names.includes(x)) {
                // If artist is found, print name in green
                error.innerHTML = "<span style='color: green;'>" +
                    "Artist Chosen: " + x + "</span>";
                form.reset();
                // Then generate the graph
                createGraph(x);
                // After graph creation, display artist blocks below
                // document.getElementById("artistData").style.display = "block";
                if (start != 0) {
                    // If a new artist is selected, clear graph
                    // chart.dispose();
                    $('#artist_graph').empty();
                } else {
                    start = 1;
                }
            } else {
                // If artist is not found, print red error
                error.innerHTML = "<span style='color: red;'>" +
                    "Artist not found</span>";
                form.reset();
            }
        }

        // This function creates the artist graph
        function createGraph(art_name) {
            var myHeaders = new Headers();
            myHeaders.append("Content-Type", "application/json");

            var requestOptions = {
                method: 'GET',
                headers: myHeaders,
                redirect: 'follow'
            };

            var artist_name = art_name;
            var links;
            var data;

            fetch("https://rmanaqd7j4.execute-api.us-east-1.amazonaws.com/default/spot?artist=" + artist_name, requestOptions)
                .then(response => response.text())
                .then(function (data) {
                    data = JSON.parse(data)
                    data = data['body']

                    links = data['edges'];
                })
                .then(function (f) {
                    var nodes = {};

                    links.forEach(function (link) {
                        link.from = nodes[link.from] || (nodes[link.from] = { name: link.from });
                        link.to = nodes[link.to] || (nodes[link.to] = { name: link.to });
                    });

                    for (const [key, value] of Object.entries(links)) {
                        links[key]['source'] = { "name": links[key]['from'] }
                        links[key]['target'] = { "name": links[key]['to'] }
                        links[key]['value'] = links[key]['freq']
                    }

                    console.log(nodes)
                    console.log(links)
                    var width = 800;
                    var height = 800;

                    var force = d3.forceSimulation()
                        .nodes(d3.values(nodes))
                        .force("link", d3.forceLink(links).distance(100))
                        .force('center', d3.forceCenter(width / 2, height / 2))
                        .force("x", d3.forceX())
                        .force("y", d3.forceY())
                        .force("charge", d3.forceManyBody().strength(-250))
                        .alphaTarget(1)
                        .on("tick", tick);

                    var svg = d3.select("#artist_graph")

                    var path = svg.append("g")
                        .attr("stroke", "#FF0000")
                        .selectAll("path")
                        .data(links)
                        .enter()
                        .append("path")
                        .attr("class", function (d) { return "link " + d.type; })
                        .style("stroke", function (d) {
                            if (d.freq >= 1000) {
                                return "green";
                            } else {
                                return "gray"
                            }
                        })
                        .style("stroke-width", 2);

                    var node = svg.selectAll(".node")
                        .data(force.nodes())
                        .enter().append("g")
                        .attr("class", "node");

                    node.append("circle")
                        .attr("id", function (d) {
                            return (d.name.replace(/\s+/g, '').toLowerCase());
                        })
                        .attr("r", function (d) {
                            if (d.index == 0) {
                                return 30
                            } else if (d.index <= 10) {
                                return 15
                            } else {
                                return 8
                            }
                        })
                        .style("fill", function (d) {
                            if (d.index == 0) {
                                return "green"
                            } else if (d.index <= 10) {
                                return "lightblue"
                            } else {
                                return "gray"
                            }
                        })
                        .each(function () {
                            d3.select(this).on('click', function (d) {
                            })
                        });

                    node.append('text')
                        .style("font-weight", 700)
                        .text(function (d) {
                            return d.name;
                        })
                        .attr('x', 0)
                        .attr('y', 0);

                    function tick() {
                        path.attr("d", function (d) {
                            var dx = d.to.x - d.from.x,
                                dy = d.to.y - d.from.y,
                                dr = Math.sqrt(dx * dx + dy * dy);
                            return "M" +
                                d.from.x + "," +
                                d.from.y + "A" +
                                dr + "," + dr + " 0 0,1 " +
                                d.to.x + "," +
                                d.to.y;
                        });

                        node.attr("transform", function (d) {
                            return "translate(" + d.x + "," + d.y + ")";
                        });
                    };

                }).catch(function (error) {
                    console.log(error);
                });
        }
    </script>
</body>

</html>
